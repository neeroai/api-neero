{
  "name": "AI Agent Deployment Conversation - multimodal",
  "trigger": {
    "type": "conversation",
    "data": {
      "channelId": "f33977c7-1f94-5107-998b-8fb04853afa6",
      "connectorTemplateSlug": "whatsapp:1.0",
      "event": "created",
      "participantTypes": ["contact"]
    },
    "metadata": {
      "sourceId": "f33977c7-1f94-5107-998b-8fb04853afa6",
      "hookId": "187a32b5-ef22-4c6f-983b-b771b1cb9127",
      "sources": [
        {
          "sourceId": "f33977c7-1f94-5107-998b-8fb04853afa6",
          "hookId": "187a32b5-ef22-4c6f-983b-b771b1cb9127"
        }
      ],
      "testingSourceId": "00000000-0000-0000-0000-000000000000",
      "additionResources": null
    }
  },
  "definition": {
    "startAt": "getContact_ul0p",
    "steps": {
      "conditional_Smqu": {
        "type": "conditional",
        "conditionals": [
          {
            "label": "Agent Status = Handover",
            "or": [
              {
                "variable": "{{steps.llmbotNewConversation_6emL.event.llmBotChat.status|default:\"empty\"}}",
                "stringEquals": "handover"
              },
              {
                "variable": "{{steps.llmbotNewConversation_6emL.event.llmBotChat.status|default:\"empty\"}}",
                "stringEquals": "error"
              }
            ],
            "next": "createItemRoute_qaKk"
          },
          {
            "label": "Agent Status = Resolved",
            "variable": "{{steps.llmbotNewConversation_6emL.event.llmBotChat.status|default:\"empty\"}}",
            "stringEquals": "resolved",
            "next": "updateFeedItem_wKXn"
          },
          {
            "label": "Agent Status = Human Takeover",
            "variable": "{{steps.llmbotNewConversation_6emL.event.llmBotChat.status|default:\"empty\"}}",
            "stringEquals": "takeover",
            "next": "terminate_S7FO"
          },
          {
            "label": "Agent Status = Abandoned",
            "variable": "{{steps.llmbotNewConversation_6emL.event.llmBotChat.status|default:\"empty\"}}",
            "stringEquals": "abandoned",
            "next": "updateFeedItem_abandoned"
          }
        ],
        "default": "createItemRoute_xrvE"
      },
      "createComment_XIg9": {
        "type": "mrn:v1:collaboration:endpoints:createComment:1.0.0",
        "comment": "Adds Agent Resolution and Handover Reason as a comment",
        "parameters": {
          "payload": {
            "body": {
              "text": {
                "text": "AI Agent Resolution: {{steps.llmbotNewConversation_6emL.event.llmBotChat.status|default:\"empty\"}}\nAI Agent Handover Reason: {{steps.llmbotNewConversation_6emL.event.llmBotChat.finalizationDetails.handoverReason|default:\"resolved\"}}"
              },
              "type": "text"
            }
          },
          "request": {
            "feedId": "channel:{{trigger.payload.conversation.channelId}}",
            "itemId": "{{trigger.payload.conversation.conversationId}}",
            "workspaceId": "{{run.workspaceId}}"
          }
        },
        "catch": [
          { "errorEquals": ["Steps.All"], "action": { "type": "continue" } }
        ],
        "next": "conditional_Smqu"
      },
      "createItemRoute_qaKk": {
        "type": "mrn:v1:collaboration:endpoints:createItemRoute:1.0.0",
        "parameters": {
          "payload": {
            "agent": {
              "basedOn": {
                "basedOnAvailability": false,
                "basedOnTags": false,
                "basedOnTeams": false
              },
              "orderBy": "assignedFeedCount"
            },
            "routeTo": "agent"
          },
          "request": {
            "feedId": "channel:{{trigger.payload.conversation.channelId}}",
            "itemId": "{{trigger.payload.conversation.conversationId}}",
            "workspaceId": "{{run.workspaceId}}"
          }
        },
        "next": "terminate_Ncl2"
      },
      "createItemRoute_xrvE": {
        "type": "mrn:v1:collaboration:endpoints:createItemRoute:1.0.0",
        "parameters": {
          "payload": {
            "agent": {
              "basedOn": {
                "basedOnAvailability": false,
                "basedOnTags": false,
                "basedOnTeams": false
              },
              "orderBy": "assignedFeedCount"
            },
            "routeTo": "agent"
          },
          "request": {
            "feedId": "channel:{{trigger.payload.conversation.channelId}}",
            "itemId": "{{trigger.payload.conversation.conversationId}}",
            "workspaceId": "{{run.workspaceId}}"
          }
        }
      },
      "getContact_ul0p": {
        "type": "mrn:v1:contacts:endpoints:getContact:1.0.0",
        "parameters": {
          "request": {
            "attribute": [],
            "contactId": "{{trigger.payload.conversation.featuredParticipants[0].participantId}}",
            "workspaceId": "{{run.workspaceId}}"
          }
        },
        "next": "llmbotNewConversation_6emL"
      },
      "llmbotNewConversation_6emL": {
        "type": "mrn:v1:bots:endpoints:llmbotNewConversation:1.0.0",
        "comment": "AI Agent accepts new conversation, will only continue when it resolves, hands over, or errors  ",
        "parameters": {
          "payload": {
            "conversationId": "{{trigger.payload.conversation.conversationId}}",
            "initialData": null
          },
          "request": {
            "agentId": "03725e24-c835-4dfa-980c-ec8a01b5f71c",
            "workspaceId": "{{run.workspaceId}}"
          },
          "waitConditions": {
            "events": [
              { "action": "continue", "name": "llmbots_chat_resolved" },
              { "action": "continue", "name": "llmbots_chat_agent_handover" },
              { "action": "continue", "name": "llmbots_chat_failed" },
              { "action": "continue", "name": "llmbots_chat_agent_takeover" },
              { "action": "continue", "name": "llmbots_chat_agent_abandoned" }
            ],
            "timeout": "PT12H"
          }
        },
        "catch": [
          { "errorEquals": ["Steps.All"], "action": { "type": "continue" } }
        ],
        "next": "createComment_XIg9"
      },
      "terminate_6CnQ": {
        "type": "terminate",
        "parameters": { "code": "", "fail": false, "reason": "Resolved" }
      },
      "terminate_Ncl2": {
        "type": "terminate",
        "parameters": { "code": "", "fail": false, "reason": "Human handover" }
      },
      "terminate_S7FO": {
        "type": "terminate",
        "parameters": { "code": "", "fail": false, "reason": "Human takeover" }
      },
      "terminate_gDnt": {
        "type": "terminate",
        "parameters": {
          "code": "",
          "fail": false,
          "reason": "User abandoned conversation"
        }
      },
      "updateFeedItem_abandoned": {
        "type": "mrn:v1:collaboration:endpoints:updateFeedItem:1.0.0",
        "comment": "Closes abandoned feed items",
        "parameters": {
          "payload": { "closed": true },
          "request": {
            "feedId": "channel:{{trigger.payload.conversation.channelId}}",
            "itemId": "{{trigger.payload.conversation.conversationId}}",
            "workspaceId": "{{run.workspaceId}}"
          }
        },
        "next": "terminate_gDnt"
      },
      "updateFeedItem_wKXn": {
        "type": "mrn:v1:collaboration:endpoints:updateFeedItem:1.0.0",
        "comment": "Closes resolved feed items",
        "parameters": {
          "payload": { "closed": true },
          "request": {
            "feedId": "channel:{{trigger.payload.conversation.channelId}}",
            "itemId": "{{trigger.payload.conversation.conversationId}}",
            "workspaceId": "{{run.workspaceId}}"
          }
        },
        "next": "terminate_6CnQ"
      }
    }
  }
}
